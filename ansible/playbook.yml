---
- name: Deploy Full Stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    app_image: app-image:latest
    vpn_image: vpn-image:latest
    k8s_dir: ../k8s
    app_port: 30030
    grafana_port: 30060
    kibana_port: 30090
    minikube_cpus: 4
    minikube_memory: 6144
    minikube_driver: docker

  tasks:
  - name: Delete existing Minikube cluster (if any)
    command: minikube delete
    register: delete_result
    # Prevent failure if minikube is not currently running
    ignore_errors: true 

  - name: Start Minikube with required resources
    command: >
      minikube start 
      --cpus={{ minikube_cpus }} 
      --memory={{ minikube_memory }} 
      --driver={{ minikube_driver }}
    register: start_output

  - name: Display Minikube status
    debug:
      msg: "{{ start_output.stdout_lines }}"

  - name: Build app image inside Minikube
    command: minikube image build -t {{ app_image }} ../app

  - name: Build vpn image inside Minikube
    command: minikube image build -t {{ vpn_image }} ../vpn

  - name: Create namespaces
    include_role:
      name: namespaces

  - name: Deploy APP stack
    include_role:
      name: app_stack

  - name: Deploy LOGGING stack
    include_role:
      name: logging_stack

  - name: Deploy MONITORING stack
    include_role:
      name: monitoring_stack

  - name: Port-forward services
    shell: |
      nohup kubectl port-forward svc/nginx {{ app_port }}:80 -n app > /dev/null 2>&1 &
      nohup kubectl port-forward svc/grafana {{ grafana_port }}:3000 -n monitoring > /dev/null 2>&1 &
      nohup kubectl port-forward svc/kibana {{ kibana_port }}:5601 -n logging > /dev/null 2>&1 &
    async: 3600
    poll: 0
