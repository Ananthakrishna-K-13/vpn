---
- name: Deploy VPN + App + Monitoring + Logging Stack
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    app_image: app-image:latest
    vpn_image: vpn-image:latest
    k8s_dir: ../k8s
    app_namespace: app
    monitoring_namespace: monitoring
    logging_namespace: logging
    app_port: 30030
    grafana_port: 30060
    kibana_port: 30090
    minikube_cpus: 4
    minikube_memory: 6144
    minikube_driver: docker

  tasks:
  - name: Delete existing Minikube cluster (if any)
    command: minikube delete
    register: delete_result
    # Prevent failure if minikube is not currently running
    ignore_errors: true 

  - name: Start Minikube with required resources
    command: >
      minikube start 
      --cpus={{ minikube_cpus }} 
      --memory={{ minikube_memory }} 
      --driver={{ minikube_driver }}
    register: start_output

  - name: Display Minikube status
    debug:
      msg: "{{ start_output.stdout_lines }}"

  - name: Set Docker environment to point to Minikube
    shell: eval $(minikube docker-env)
    register: docker_env
    ignore_errors: yes

  - name: Docker env
    debug:
      msg: "{{ docker_env.stdout }}"

  - name: Build app Docker image
    shell: docker build -t {{ app_image }} ../app
    register: build_app
    ignore_errors: no

  - name: App build output
    debug:
      msg: "{{ build_app.stdout }}"

  - name: Build vpn Docker image
    shell: docker build -t {{ vpn_image }} ../vpn
    register: build_vpn
    ignore_errors: no

  - name: VPN build output
    debug:
      msg: "{{ build_vpn.stdout }}"

  - name: Apply all Kubernetes manifests
    shell: kubectl apply -k {{ k8s_dir }}/
    register: k8s_apply
    ignore_errors: no

  - name: K8s apply output
    debug:
      msg: "{{ k8s_apply.stdout }}"
